<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä½ å¥½å•Šæˆ‘æ˜¯ç”·åŒ</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ffb86b;--muted:#94a3b8;--win:#34d399;--lose:#fb7185;font-family:Inter,system-ui,Arial}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#071025);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:16px}
    .card{width:100%;max-width:760px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    p.lead{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .game-area{display:flex;gap:12px;margin-top:12px}
    .board{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .cell{background:#0c1220;border-radius:8px;padding:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;min-height:120px}
    .cell img{max-width:100%;max-height:100%;object-fit:contain;border-radius:6px}
    .sidebar{width:220px;display:flex;flex-direction:column;gap:10px}
    .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .btn{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
    .btn.game-over{display:none;margin-top:8px;width:100%}
    .btn.game-over.show{display:block}
    .btn.reset-achievements{background:transparent;border:1px solid rgba(255,184,107,0.3);color:var(--accent);font-size:12px;padding:6px 8px;margin-top:4px;width:100%}
    .message{padding:8px;border-radius:8px;text-align:center;display:none}
    .message.show{display:block}
    .message.win{color:var(--win)}
    .message.lose{color:var(--lose)}
    .message.limit{
      color:var(--accent);
      font-size:16px;
      font-weight:700;
      animation: pulse 0.5s ease-in-out infinite alternate;
      background: rgba(255,184,107,0.1);
      border:1px solid rgba(255,184,107,0.3);
    }
    @keyframes pulse{
      from{transform:scale(1);opacity:0.9}
      to{transform:scale(1.05);opacity:1}
    }
    .score-notice{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(15,23,36,0.95);border:2px solid var(--accent);border-radius:8px;padding:12px 20px;font-size:18px;font-weight:700;color:var(--accent);z-index:999;animation:popup 0.3s ease-in-out;display:none}
    .score-notice.show{display:block}
    @keyframes popup{0%{opacity:0;transform:translateX(-50%) translateY(-20px)}100%{opacity:1;transform:translateX(-50%) translateY(0)}}
    footer.ad{margin-top:12px;padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
    .cta{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:var(--accent);color:#071025;font-weight:700;text-decoration:none}
    .flash{animation:flash 1s linear infinite}
    @keyframes flash{0%,100%{opacity:1}50%{opacity:0.25}}
    /* æˆå°±å¢™æ ·å¼ */
    .achievements{margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .achievements h3{font-size:14px;margin:0 0 8px;color:var(--accent)}
    .achievement-list{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .achievement-item{background:rgba(255,255,255,0.01);padding:6px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:4px}
    .achievement-item.locked{color:var(--muted);opacity:0.6}
    .achievement-item.unlocked{color:var(--win)}
    .achievement-icon{width:16px;height:16px;display:flex;align-items:center;justify-content:center}
    .achievement-icon.locked::after{content:"ğŸ”’"}
    .achievement-icon.unlocked::after{content:"ğŸ†"}
    /* åˆ†äº«æŒ‰é’®æ ·å¼ */
    .share-container{margin-top:8px;display:flex;gap:8px}
    .share-btn{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all 0.2s}
    .share-btn:hover{background:rgba(255,255,255,0.02)}
    .share-btn i{font-size:14px}
    .share-btn span{font-size:12px}
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--card);padding:20px;border-radius:12px;width:90%;max-width:400px;border:1px solid rgba(255,255,255,0.05)}
    .modal-title{font-size:16px;margin:0 0 12px;color:var(--accent)}
    .modal-message{font-size:14px;margin:0 0 16px;color:var(--muted)}
    .modal-buttons{display:flex;gap:8px;justify-content:flex-end}
    .modal-btn{padding:8px 16px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .modal-btn.confirm{background:var(--win);color:#071025}
    .modal-btn.cancel{background:var(--lose);color:white}
    .modal-btn.special{background:var(--accent);color:#071025}
    /* æ¸¸æˆç»“æŸç»Ÿè®¡ */
    .game-stats{margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:none}
    .game-stats.show{display:block}
    .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center}
    .stat-item{background:rgba(255,255,255,0.01);padding:8px;border-radius:6px}
    .stat-label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .stat-value{font-size:16px;font-weight:700}
    @media (max-width:700px){.game-area{flex-direction:column}.sidebar{width:100%;flex-direction:row}.achievement-list{grid-template-columns:repeat(3,1fr)}.stats-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
  <!-- å¼•å…¥Font Awesomeç”¨äºåˆ†äº«å›¾æ ‡ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>ä½ å¥½å•Šæˆ‘æ˜¯ç”·åŒ</h1>
        <p class="lead">æ¯å…³æ˜¯éšæœºé¢˜ç›®ã€‚è¯·æŒ‰ä¸‹é¢"å¼€å§‹"æµ‹è¯•ã€‚å›¾ç‰‡ä¸å¹¿å‘Šç´ æè¯·æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶æˆ–å¤–é“¾ã€‚</p>
      </div>
      <div style="font-size:12px;color:var(--muted)">é€‚åˆå½“ä½œäº’åŠ¨å¹¿å‘Šç´ æ</div>
    </header>

    <div class="game-area">
      <div class="board">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:13px;color:var(--muted)">å…³å¡ï¼š<span id="round">â€”</span></div>
          <div id="questionText" style="font-size:13px;color:var(--muted)">é¢˜ç›®å°†éšæœºå‡ºç°</div>
        </div>

        <div id="grid" class="grid" aria-label="è§’è‰²ç½‘æ ¼"></div>
        <div id="message" class="message" role="status" aria-live="polite"></div>
        <button id="btnPlayAgain" class="btn game-over">å†æ¥ä¸€å±€</button>
        <button id="btnEndGame" class="btn game-over secondary">ç»“æŸæ¸¸æˆ</button>
        
        <!-- åˆ†äº«æŒ‰é’® -->
        <div class="share-container">
          <button id="btnShareWechat" class="share-btn">
            <i class="fab fa-weixin" style="color:#07c160"></i>
            <span>å¾®ä¿¡</span>
          </button>
          <button id="btnShareQQ" class="share-btn">
            <i class="fab fa-qq" style="color:#12b7f5"></i>
            <span>QQ</span>
          </button>
          <button id="btnShareScreenshot" class="share-btn">
            <i class="fas fa-share-alt" style="color:var(--accent)"></i>
            <span>æˆªå›¾</span>
          </button>
        </div>
      </div>

      <aside class="sidebar">
        <div class="stat"><div style="font-size:12px;color:var(--muted)">å€’è®¡æ—¶</div><div id="timer" style="font-size:18px;font-weight:700">--</div></div>
        <div class="stat"><div style="font-size:12px;color:var(--muted)">åˆ†æ•°</div><div id="score" style="font-size:18px;font-weight:700">0</div></div>
        <div class="controls">
          <button id="btnRestart" class="btn secondary">é‡ç½®</button>
          <button id="btnStart" class="btn">å¼€å§‹â™‚æ¸¸æˆ</button>
        </div>
        <button id="btnResetAchievements" class="btn reset-achievements">æˆâ™‚å°±é‡å¼€</button>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">æç¤ºï¼šç‚¹å‡»ä»»ä¸€å›¾ç‰‡é€‰æ‹©ç­”æ¡ˆï¼ˆå•é€‰ï¼‰</div>
      </aside>
    </div>

    <!-- æˆå°±å¢™ -->
    <div class="achievements">
      <h3>æˆå°±å¢™</h3>
      <div id="achievementList" class="achievement-list">
        <div class="achievement-item locked" data-id="straight">
          <div class="achievement-icon locked"></div>
          <div>æˆ‘æ˜¯ç›´ç”·</div>
        </div>
        <div class="achievement-item locked" data-id="gayPride">
          <div class="achievement-icon locked"></div>
          <div>éª„å‚²ä¹‹GAY</div>
        </div>
        <div class="achievement-item locked" data-id="chef">
          <div class="achievement-icon locked"></div>
          <div>ä½ æ˜¯é£Ÿæå—</div>
        </div>
        <div class="achievement-item locked" data-id="therapist">
          <div class="achievement-icon locked"></div>
          <div>å¿ƒç†æ²»ç–—å¸ˆ</div>
        </div>
        <div class="achievement-item locked" data-id="maxScore">
          <div class="achievement-icon locked"></div>
          <div>å¤©é€‰ç”·åŒğŸŒˆ</div>
        </div>
        <div class="achievement-item locked" data-id="forgotSomeone">
          <div class="achievement-icon locked"></div>
          <div>å¥½åƒå¿˜äº†è°...</div>
        </div>
        <div class="achievement-item locked" data-id="forceful">
          <div class="achievement-icon locked"></div>
          <div>å¼ºäººæ‰€éš¾â™‚</div>
        </div>
        <!-- éšè—æˆå°±ä¸æ˜¾ç¤ºåœ¨æˆå°±å¢™ -->
      </div>
    </div>

    <!-- æ¸¸æˆç»“æŸç»Ÿè®¡ -->
    <div id="gameStats" class="game-stats">
      <h3 style="font-size:14px;margin:0 0 8px;color:var(--accent)">æ¸¸æˆç»Ÿè®¡</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">æœ€ç»ˆå¾—åˆ†</div>
          <div id="finalScore" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">æ­£ç¡®æ¬¡æ•°</div>
          <div id="correctCount" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">é”™è¯¯æ¬¡æ•°</div>
          <div id="wrongCount" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">æ€»å…³å¡æ•°</div>
          <div id="totalRounds" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">è§£é”æˆå°±</div>
          <div id="unlockedAchievements" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">æ­£ç¡®ç‡</div>
          <div id="accuracyRate" class="stat-value">0%</div>
        </div>
      </div>
    </div>

    <footer class="ad">
      <div style="font-size:13px;color:var(--muted)">å¹¿å‘ŠåŒºï¼ˆç‚¹å‡»å¯è·³è½¬åˆ°ä½ çš„æ¨å¹¿é¡µé¢ï¼‰</div>
      <a id="ctaLink" class="cta" href="#" role="link">
        <img id="ctaImg" src="flash.gif" alt="ç‚¹å‡»â™‚è¿™é‡Œï¼ˆæˆ‘è¿˜æ²¡è°ƒå¥½ï¼‰" style="width:36px;height:36px;object-fit:contain;border-radius:6px"> 
        <span class="flash">ç‚¹å‡»â™‚è¿™é‡Œï¼ˆæˆ‘è¿˜æ²¡è°ƒå¥½ï¼‰</span>
      </a>
    </footer>
  </div>
  <div id="scoreNotice" class="score-notice"></div>

  <!-- é‡ç½®æˆå°±æ¨¡æ€æ¡† -->
  <div id="resetAchievementsModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">æˆâ™‚å°±é‡å¼€</h3>
      <p class="modal-message">hwjæ¸©é¦¨æç¤ºï¼šæ˜¯å¦è¦é‡ç½®æˆå°±ï¼ˆåæ­£æˆ‘ä¹Ÿæ²¡æ·»åŠ æ›´å¤šï¼‰</p>
      <div class="modal-buttons">
        <button id="btnConfirmReset" class="modal-btn confirm">æ˜¯</button>
        <button id="btnSpecialReset" class="modal-btn special">yeahâ™‚</button>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      images: [
        "img1.jpg",
        "img2.jpg",
        "img3.jpg",
        "img4.jpg"
      ],
      adMedia: "ad-banner.gif",
      adLink: "https://ä½ çš„æ¨å¹¿é“¾æ¥.com",
      timeLimit: 8,
      maxScore: 100,
      pointsPerCorrect: 5,
    };

    const QUESTIONS = [
      {
        id:1,
        text: 'æ‰¾å‡ºé‡Œé¢æ‰€æœ‰ç”·åŒ',
        type:'special-single',
        onSelect: function(idx){
          return {ok:false, msg:'å“ˆå“ˆéª—ä½ çš„ï¼Œæˆ‘åªè®¾ç½®äº†å•é€‰'};
        }
      },
      {
        id:2,
        text: 'æ‰¾å‡ºçœŸæ­£çš„å¨å¸ˆ',
        type:'single',
        correctOriginalIndex: 0,
        onCorrectMsg: 'ä½ çœ‹èµ·æ¥å¾ˆå¥½åƒ',
        onWrongMsg: 'Cazzoï¼Œä½ ä¸è®¤è¯†æˆ‘å—',
        achievement: 'chef'
      },
      {
        id:3,
        text: 'æ‰¾å‡ºå¤±å»äº†çƒæ£çš„å¿ƒç†æ²»ç–—å¸ˆ',
        type:'single',
        correctOriginalIndex: 3,
        onWrongMsg: 'å†é€‰é”™å°±è¿‡æ¥å¿ƒç†æ²»ç–—',
        onCorrectMsg: 'éš”å£ä»–ç”·äººåœ¨åŒæŒing',
        achievement: 'therapist'
      },
      {
        id:4,
        text: 'æ‰¾å‡ºå›¾ä¸­çš„ç›´ç”·',
        type:'single-multi-text',
        onSelect: function(originalIndex){
          if(originalIndex===0||originalIndex===1) {
            unlockAchievement('straight');
            return {ok:true, msg:'ğŸ’æˆ‘ä»¬æ˜¯çœŸæ­£çš„â™‚ç›´ç”·â™‚å‘€'};
          } else {
            unlockAchievement('gayPride');
            return {ok:true, msg:'ğŸŒˆğŸŒˆğŸŒˆéª„å‚²ä¹‹â™‚GAYğŸŒˆğŸŒˆğŸŒˆ'};
          }
        }
      }
    ];

    let gridEl = document.getElementById('grid');
    let timerEl = document.getElementById('timer');
    let scoreEl = document.getElementById('score');
    let messageEl = document.getElementById('message');
    let questionTextEl = document.getElementById('questionText');
    let roundEl = document.getElementById('round');
    let ctaLink = document.getElementById('ctaLink');
    let ctaImg = document.getElementById('ctaImg');
    let scoreNoticeEl = document.getElementById('scoreNotice');
    let btnPlayAgain = document.getElementById('btnPlayAgain');
    let btnEndGame = document.getElementById('btnEndGame');
    let achievementList = document.getElementById('achievementList');
    let btnShareWechat = document.getElementById('btnShareWechat');
    let btnShareQQ = document.getElementById('btnShareQQ');
    let btnShareScreenshot = document.getElementById('btnShareScreenshot');
    let btnResetAchievements = document.getElementById('btnResetAchievements');
    let resetAchievementsModal = document.getElementById('resetAchievementsModal');
    let btnConfirmReset = document.getElementById('btnConfirmReset');
    let btnSpecialReset = document.getElementById('btnSpecialReset');
    let gameStats = document.getElementById('gameStats');
    let finalScoreEl = document.getElementById('finalScore');
    let correctCountEl = document.getElementById('correctCount');
    let wrongCountEl = document.getElementById('wrongCount');
    let totalRoundsEl = document.getElementById('totalRounds');
    let unlockedAchievementsEl = document.getElementById('unlockedAchievements');
    let accuracyRateEl = document.getElementById('accuracyRate');

    let timeLeft = CONFIG.timeLimit;
    let timer = null;
    let score = 0;
    let round = 0;
    let currentQuestion = null;
    let playable = false;
    let shuffledOriginalIndexes = [];
    let triggeredScoreNotices = new Set();
    // ä½¿ç”¨localStorageä¿å­˜æˆå°±ï¼Œé‡ç½®æ¸¸æˆä¸ä¼šæ¶ˆå¤±
    let unlockedAchievements = new Set(JSON.parse(localStorage.getItem('unlockedAchievements')) || []);
    let consecutiveImg1Count = 0;
    let consecutiveNotImg3Count = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let gameActive = false;

    ctaImg.src = CONFIG.adMedia;
    ctaLink.href = CONFIG.adLink;

    // åˆå§‹åŒ–æˆå°±æ˜¾ç¤º
    function initAchievements() {
      document.querySelectorAll('.achievement-item').forEach(item => {
        const id = item.getAttribute('data-id');
        if (unlockedAchievements.has(id)) {
          item.classList.remove('locked');
          item.classList.add('unlocked');
          item.querySelector('.achievement-icon').classList.remove('locked');
          item.querySelector('.achievement-icon').classList.add('unlocked');
        }
      });
    }

    // è§£é”æˆå°±å‡½æ•°
    function unlockAchievement(achievementId) {
      if (unlockedAchievements.has(achievementId)) return;
      
      unlockedAchievements.add(achievementId);
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('unlockedAchievements', JSON.stringify(Array.from(unlockedAchievements)));
      
      const achievementItem = document.querySelector(`.achievement-item[data-id="${achievementId}"]`);
      if (achievementItem) {
        achievementItem.classList.remove('locked');
        achievementItem.classList.add('unlocked');
        achievementItem.querySelector('.achievement-icon').classList.remove('locked');
        achievementItem.querySelector('.achievement-icon').classList.add('unlocked');
        
        // æ˜¾ç¤ºæˆå°±è§£é”æç¤º
        showScoreNotice(`ğŸ† è§£é”æˆå°±ï¼š${achievementItem.textContent.trim()}`);
      } else if (achievementId === 'omg') {
        // éšè—æˆå°±ï¼Œåªæ˜¾ç¤ºæç¤º
        showScoreNotice(`ğŸ† è§£é”éšè—æˆå°±ï¼šOMGâ™‚`);
      }
    }

    // é‡ç½®æˆå°±
    function resetAchievements(keepHidden = false) {
      if (!keepHidden) {
        unlockedAchievements.clear();
      } else {
        // ä¿ç•™éšè—æˆå°±OMGâ™‚
        const temp = new Set();
        if (unlockedAchievements.has('omg')) {
          temp.add('omg');
        }
        unlockedAchievements = temp;
      }
      localStorage.setItem('unlockedAchievements', JSON.stringify(Array.from(unlockedAchievements)));
      document.querySelectorAll('.achievement-item').forEach(item => {
        item.classList.remove('unlocked');
        item.classList.add('locked');
        item.querySelector('.achievement-icon').classList.remove('unlocked');
        item.querySelector('.achievement-icon').classList.add('locked');
      });
      showScoreNotice('æˆå°±å·²é‡ç½®ï¼');
    }

    // åˆ†äº«åŠŸèƒ½
    function shareToWechat() {
      const shareText = `æˆ‘åœ¨"ä½ å¥½å•Šæˆ‘æ˜¯ç”·åŒ"æ¸¸æˆä¸­è·å¾—äº†${score}åˆ†ï¼Œè§£é”äº†${unlockedAchievements.size}ä¸ªæˆå°±ï¼å¿«æ¥æŒ‘æˆ˜æˆ‘å§ï¼`;
      alert(`å¾®ä¿¡åˆ†äº«ï¼š${shareText}\n\nï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦é›†æˆå¾®ä¿¡JS-SDKï¼‰`);
    }

    function shareToQQ() {
      const shareText = `æˆ‘åœ¨"ä½ å¥½å•Šæˆ‘æ˜¯ç”·åŒ"æ¸¸æˆä¸­è·å¾—äº†${score}åˆ†ï¼Œè§£é”äº†${unlockedAchievements.size}ä¸ªæˆå°±ï¼å¿«æ¥æŒ‘æˆ˜æˆ‘å§ï¼`;
      window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(window.location.href)}&title=ä½ å¥½å•Šæˆ‘æ˜¯ç”·åŒ&desc=${encodeURIComponent(shareText)}&summary=&site=`, '_blank', 'width=600,height=400');
    }

    function takeScreenshot() {
      alert('æˆªå›¾åŠŸèƒ½å·²è§¦å‘ï¼\n\nï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦å¼•å…¥html2canvasåº“ï¼‰');
    }

    function shuffleArrayWithIndex(array) {
      const newArr = [...array];
      const originalIndexes = Array.from(array.keys());
      for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
        [originalIndexes[i], originalIndexes[j]] = [originalIndexes[j], originalIndexes[i]];
      }
      return { shuffledArr: newArr, originalIndexes: originalIndexes };
    }

    function showScoreNotice(text) {
      scoreNoticeEl.textContent = text;
      scoreNoticeEl.classList.add('show');
      setTimeout(() => {
        scoreNoticeEl.classList.remove('show');
      }, 3000);
    }

    function checkScoreMilestone() {
      if (score >= 50 && !triggeredScoreNotices.has(50)) {
        showScoreNotice('å¤ªæ£’äº†ï¼50åˆ†ï¼');
        triggeredScoreNotices.add(50);
      }
      if (score >= CONFIG.maxScore && !triggeredScoreNotices.has(CONFIG.maxScore)) {
        showScoreNotice('100åˆ†ï¼å¤©å‘ä½ å°±æ˜¯ç”·åŒä¹‹ç¥ï¼');
        triggeredScoreNotices.add(CONFIG.maxScore);
        unlockAchievement('maxScore');
        btnPlayAgain.classList.add('show');
        btnEndGame.classList.add('show');
      }
    }

    function renderGrid(){
      gridEl.innerHTML = '';
      const imgs = CONFIG.images.slice(0,4);
      const { shuffledArr, originalIndexes } = shuffleArrayWithIndex(imgs);
      shuffledOriginalIndexes = originalIndexes;
      for(let i=0;i<4;i++){
        const cell = document.createElement('button');
        cell.className = 'cell';
        cell.setAttribute('data-visual-index', i);
        const img = document.createElement('img');
        img.alt = `è§’è‰² ${i+1}`;
        img.src = shuffledArr[i] || '';
        cell.appendChild(img);
        cell.addEventListener('click', onCellClick);
        gridEl.appendChild(cell);
      }
    }

    function startRound(){
      if(timer) clearInterval(timer);
      timeLeft = CONFIG.timeLimit;
      timerEl.textContent = timeLeft + 's';
      round++;
      roundEl.textContent = round;
      currentQuestion = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
      questionTextEl.textContent = currentQuestion.text;
      renderGrid();
      playable = true;
      setMessage('','');
      timer = setInterval(()=>{
        timeLeft--;
        timerEl.textContent = timeLeft + 's';
        if(timeLeft<=0){
          clearInterval(timer);
          playable = false;
          handleTimeout();
        }
      },1000);
    }

    function handleTimeout(){
      if(!currentQuestion) return;
      setMessage('æ‚é±¼ æ…¢æ­»äº†','lose');
      wrongCount++;
      setTimeout(()=>{
        if (gameActive) {
          startRound();
        }
      },1300);
    }

    function onCellClick(e){
      if(!playable) return;
      playable = false;
      clearInterval(timer);
      const visualIndex = Number(e.currentTarget.getAttribute('data-visual-index'));
      const originalIndex = shuffledOriginalIndexes[visualIndex];

      // æ£€æŸ¥è¿ç»­é€‰æ‹©ç»Ÿè®¡
      if (originalIndex === 0) { // img1.jpg
        consecutiveImg1Count++;
        consecutiveNotImg3Count = 0;
        if (consecutiveImg1Count >= 4) {
          unlockAchievement('forceful');
          consecutiveImg1Count = 0;
        }
      } else if (originalIndex !== 2) { // ä¸æ˜¯img3.jpg
        consecutiveNotImg3Count++;
        consecutiveImg1Count = 0;
        if (consecutiveNotImg3Count >= 4) {
          unlockAchievement('forgotSomeone');
          consecutiveNotImg3Count = 0;
        }
      } else { // é€‰æ‹©äº†img3.jpg
        consecutiveImg1Count = 0;
        consecutiveNotImg3Count = 0;
      }

      if(currentQuestion.type==='special-single'){
        setMessage('å“ˆå“ˆéª—ä½ çš„ï¼Œæˆ‘åªè®¾ç½®äº†å•é€‰','lose');
        wrongCount++;
        setTimeout(()=>{
          if (gameActive) {
            startRound();
          }
        },1200);
        return;
      }

      if(currentQuestion.type==='single'){
        if(originalIndex===currentQuestion.correctOriginalIndex){
          if (score < CONFIG.maxScore) {
            score += CONFIG.pointsPerCorrect;
            if (score > CONFIG.maxScore) score = CONFIG.maxScore;
            scoreEl.textContent = score;
            checkScoreMilestone();
            setMessage(currentQuestion.onCorrectMsg,'win');
            correctCount++;
            
            if (currentQuestion.achievement) {
              unlockAchievement(currentQuestion.achievement);
            }
          } else {
            setMessage('å·²ç»...æé™äº†â™‚â™‚â™‚','limit');
          }
        } else {
          setMessage(currentQuestion.onWrongMsg,'lose');
          wrongCount++;
        }
        setTimeout(()=>{
          if (gameActive) {
            startRound();
          }
        },1300);
        return;
      }

      if(currentQuestion.type==='single-multi-text'){
        const res = currentQuestion.onSelect(originalIndex);
        if(res){
          if(res.ok){
            if (score < CONFIG.maxScore) {
              score += CONFIG.pointsPerCorrect;
              if (score > CONFIG.maxScore) score = CONFIG.maxScore;
              scoreEl.textContent = score;
              checkScoreMilestone();
              setMessage(res.msg,'win');
              correctCount++;
            } else {
              setMessage('å·²ç»...æé™äº†â™‚â™‚â™‚','limit');
            }
          }
          else {
            setMessage(res.msg,'lose');
            wrongCount++;
          }
        }
        setTimeout(()=>{
          if (gameActive) {
            startRound();
          }
        },1300);
        return;
      }

      setMessage('å‘ç”Ÿé”™è¯¯ï¼Œé‡è¯•','lose');
      wrongCount++;
      setTimeout(()=>{
        if (gameActive) {
          startRound();
        }
      },1200);
    }

    function setMessage(text, type){
      messageEl.className = 'message';
      if(type==='win') messageEl.classList.add('win','show');
      else if(type==='lose') messageEl.classList.add('lose','show');
      else if(type==='limit') messageEl.classList.add('limit','show');
      if(text) messageEl.textContent = text; else messageEl.textContent = '';
    }

    function resetGame() {
      if(timer) clearInterval(timer);
      round = 0;
      score = 0;
      scoreEl.textContent = score;
      timeLeft = CONFIG.timeLimit;
      timerEl.textContent = '--';
      gridEl.innerHTML = '';
      setMessage('ç‚¹å‡»"å¼€å§‹â™‚æ¸¸æˆ"å¼€å§‹æŒ‘æˆ˜','');
      triggeredScoreNotices.clear();
      consecutiveImg1Count = 0;
      consecutiveNotImg3Count = 0;
      correctCount = 0;
      wrongCount = 0;
      btnPlayAgain.classList.remove('show');
      btnEndGame.classList.remove('show');
      gameStats.classList.remove('show');
      gameActive = false;
    }

    function endGame() {
      gameActive = false;
      if(timer) clearInterval(timer);
      playable = false;
      
      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      const totalAnswers = correctCount + wrongCount;
      const accuracy = totalAnswers > 0 ? Math.round((correctCount / totalAnswers) * 100) : 0;
      
      // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
      finalScoreEl.textContent = score;
      correctCountEl.textContent = correctCount;
      wrongCountEl.textContent = wrongCount;
      totalRoundsEl.textContent = round;
      unlockedAchievementsEl.textContent = unlockedAchievements.size;
      accuracyRateEl.textContent = `${accuracy}%`;
      
      // æ˜¾ç¤ºç»Ÿè®¡é¢æ¿ï¼Œéšè—æ¸¸æˆæŒ‰é’®
      gameStats.classList.add('show');
      btnPlayAgain.classList.remove('show');
      btnEndGame.classList.remove('show');
      
      showScoreNotice(`æ¸¸æˆç»“æŸï¼æœ€ç»ˆå¾—åˆ†ï¼š${score}åˆ†`);
    }

    document.getElementById('btnStart').addEventListener('click', ()=>{ 
      resetGame();
      gameActive = true;
      startRound(); 
    });
    document.getElementById('btnRestart').addEventListener('click', resetGame);
    document.getElementById('btnPlayAgain').addEventListener('click', ()=>{ 
      resetGame();
      gameActive = true;
      startRound(); 
    });
    document.getElementById('btnEndGame').addEventListener('click', endGame);

    btnShareWechat.addEventListener('click', shareToWechat);
    btnShareQQ.addEventListener('click', shareToQQ);
    btnShareScreenshot.addEventListener('click', takeScreenshot);

    // é‡ç½®æˆå°±æŒ‰é’®äº‹ä»¶
    btnResetAchievements.addEventListener('click', () => {
      resetAchievementsModal.classList.add('show');
    });

    // æ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
    btnConfirmReset.addEventListener('click', () => {
      resetAchievements(false);
      resetAchievementsModal.classList.remove('show');
    });

    btnSpecialReset.addEventListener('click', () => {
      unlockAchievement('omg');
      resetAchievements(true); // ä¿ç•™OMGâ™‚æˆå°±
      resetAchievementsModal.classList.remove('show');
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    resetAchievementsModal.addEventListener('click', (e) => {
      if (e.target === resetAchievementsModal) {
        resetAchievementsModal.classList.remove('show');
      }
    });

    // åˆå§‹åŒ–æˆå°±æ˜¾ç¤º
    initAchievements();
    setMessage('ç‚¹å‡»"å¼€å§‹â™‚æ¸¸æˆ"å¼€å§‹æŒ‘æˆ˜','');
  </script>
</body>
</html>